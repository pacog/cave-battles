"use strict";angular.module("caveBattles.battle-view.tunnel",[]).directive("tunnel",function(){return{restrict:"E",templateUrl:"app/battle-view/tunnel/tunnel.tpl.html",scope:{tunnelInfo:"="},replace:!0}}),angular.module("caveBattles.battle-view.node",["caveBattles.battle-view.node-controller"]).directive("node",function(){return{restrict:"E",templateUrl:"app/battle-view/node/node.tpl.html",scope:{nodeInfo:"="},controller:"NodeCtrl",replace:!0}}),function(){function e(e,t){e.nodeClicked=function(n){n.stopPropagation(),e.nodeInfo.canBeReachedBySelectedNode?t.requestNodeForcesToGoToNode(e.nodeInfo):t.requestSelection(e.nodeInfo)},e.getTopFill=function(){return e.nodeInfo.partialOwner?100*(1-e.nodeInfo.ownerStrength/e.nodeInfo.DEFAULT_NODE_STRENGTH):100}}angular.module("caveBattles.battle-view.node-controller",["caveBattles.battle-handler"]).controller("NodeCtrl",e),e.$inject=["$scope","BattleHandler"]}(),angular.module("caveBattles.battle-view.army",["caveBattles.battle-view.army-controller"]).directive("army",function(){return{restrict:"E",templateUrl:"app/battle-view/army/army.tpl.html",scope:{armyInfo:"="},replace:!0,controller:"ArmyCtrl"}}),angular.module("caveBattles.battle-view.army-controller",[]).controller("ArmyCtrl",function(){}),function(){angular.module("caveBattles.utils.timer",[]).factory("Timer",function(){var e=function(){return(new Date).getTime()};return{getTime:e}})}(),function(){angular.module("caveBattles.utils.ordered-list",[]).factory("OrderedList",[function(){var e=function(e){this.init(e)};return e.prototype={init:function(e){this.orderBy=e&&e.orderBy?e.orderBy:"time",this.firstElement=null,this._currentSize=0},add:function(e){if(!this.firstElement)return this.firstElement={element:e,next:null},void this._currentSize++;for(var t=null,n=this.firstElement;n;){if(n.element[this.orderBy]>e[this.orderBy]){var i={element:e,next:n};return t?t.next=i:this.firstElement=i,void this._currentSize++}if(!n.next){var o={element:e,next:null};return n.next=o,void this._currentSize++}t=n,n=n.next}},pop:function(){var e=null;return this.firstElement&&(e=this.firstElement.element,this.firstElement=this.firstElement.next),this._currentSize--,e},remove:function(e){if(!e)return!1;for(var t=this.firstElement,n=null;t;){if(t.element===e)return n?n.next=t.next:this.firstElement=t.next,this._currentSize--,t.element;n=t,t=t.next}return!1},size:function(){return this._currentSize},forEach:function(e){for(var t=this.firstElement;t;)e(t.element),t=t.next}},e}])}(),function(){angular.module("caveBattles.utils.id-generator",[]).service("IdGenerator",function(){var e=42,t=function(){return e++};return{getNewId:t}})}(),function(){angular.module("caveBattles.utils.geometry",[]).factory("Geometry",function(){var e=function(e,t){var n=0,i=0;return n=t.x-e.x,n*=n,i=t.y-e.y,i*=i,Math.sqrt(n+i)},t=function(e,t){return{x:(e.x+t.x)/2,y:(e.y+t.y)/2}},n=function(e,t){return 180*Math.atan2(t.y-e.y,t.x-e.x)/Math.PI},i=function(e,t,n){return{x:e.x+(t.x-e.x)*n,y:e.y+(t.y-e.y)*n}};return{distanceBetweenPoints:e,pointInBetween:t,inclinationFromTwoPointsDeg:n,getPointInBetween:i}})}(),angular.module("caveBattles.main",["caveBattles.battle-handler","caveBattles.battle-view"]).controller("MainCtrl",["BattleHandler",function(e){var t={map:{nodes:[{id:"1",position:{x:10,y:10}},{id:"2",position:{x:50,y:10}},{id:"3",position:{x:90,y:10}},{id:"4",position:{x:10,y:50}},{id:"5",position:{x:50,y:50}},{id:"6",position:{x:90,y:50}},{id:"7",position:{x:10,y:90}},{id:"8",position:{x:50,y:90}},{id:"9",position:{x:90,y:90}}],tunnels:[{from:"1",to:"2"},{from:"2",to:"3"},{from:"3",to:"6"},{from:"6",to:"9"},{from:"9",to:"8"},{from:"8",to:"7"},{from:"7",to:"4"},{from:"4",to:"1"},{from:"1",to:"5"},{from:"3",to:"5"},{from:"7",to:"5"},{from:"9",to:"5"},{from:"2",to:"5"},{from:"8",to:"5"}],players:[{initialNode:"1",initialForce:10,number:"1",type:"human"},{initialNode:"9",initialForce:10,number:"2",type:"AI"},{initialNode:"7",initialForce:10,number:"3",type:"AI"},{initialNode:"3",initialForce:10,number:"4",type:"AI"}]}};e.init(t)}]),function(){function e(e,t,n){return{restrict:"E",templateUrl:"app/battle-view/battle-view.tpl.html",replace:!0,link:function(i){function o(){n.subscribeToBattleModelInitiallised(a)}function r(){function n(){t.hasEnded()||(e(t.update),window.requestAnimationFrame(n))}window.requestAnimationFrame(n)}function a(){i.battleInfo=n.model,r()}o(),i.onBackgroundClicked=function(){t.removeCurrentSelection()}}}}angular.module("caveBattles.battle-view",["caveBattles.battle-handler","caveBattles.battle-model","caveBattles.battle-view.node","caveBattles.battle-view.tunnel","caveBattles.battle-view.army"]).directive("battleView",e),e.$inject=["$timeout","BattleHandler","BattleModel"]}(),function(){angular.module("caveBattles.tunnel",["caveBattles.utils.id-generator","caveBattles.utils.geometry"]).factory("Tunnel",["IdGenerator","Geometry",function(e,t){var n=function(e,t){this.init(e,t)};return n.prototype={init:function(n,i){this.id=e.getNewId(),this.from=i[n.from],this.to=i[n.to],this.length=t.distanceBetweenPoints(this.from.position,this.to.position),this.middle=t.pointInBetween(this.from.position,this.to.position),this.inclinationDeg=t.inclinationFromTwoPointsDeg(this.from.position,this.to.position)},connectsNodes:function(e,t){return this.from.id===e.id&&this.to.id===t.id||this.to.id===e.id&&this.from.id===t.id?!0:!1}},n}])}(),function(){angular.module("caveBattles.player",["ngLodash","caveBattles.utils.id-generator"]).factory("Player",["lodash","IdGenerator",function(e,t){var n="human",i="AI",o=function(e){this.init(e)};return o.prototype={init:function(n){e.assign(this,n),this.id=t.getNewId()},isHuman:function(){return this.type===n},isAI:function(){return this.type===i}},o}])}(),function(){angular.module("caveBattles.node",["ngLodash"]).factory("Node",["lodash",function(e){var t=1,n=50,i=function(t,n){e.assign(this,t),this.currentOwner=null,this.partialOwner=null,this._setOwnerStrength(0),this.battleModel=n};return i.prototype={DEFAULT_NODE_STRENGTH:10,fillNode:function(){this.currentOwner&&this._setOwnerStrength(this.ownerStrength+t)},handleArmyArriving:function(e){e.player===this.currentOwner?(this._setOwnerStrength(this.ownerStrength+e.force),e.destroy()):e.player===this.partialOwner?e.force>=this.DEFAULT_NODE_STRENGTH-this.ownerStrength?this._setArmyAsOwner(e,this.DEFAULT_NODE_STRENGTH-this.ownerStrength):(this._setOwnerStrength(this.ownerStrength+e.force),e.destroy()):this.currentOwner||this.partialOwner?this.currentOwner&&this.currentOwner!==e.player?this._handleArmyArrivingAtEnemyNode(e):this.partialOwner&&this.partialOwner!==e.player&&this._handleArmyArrivingAtEnemyNode(e):this._handleArmyArrivingAtEmptyNode(e)},canReachNode:function(e){if(!e)return!1;for(var t=0;t<this.battleModel.model.tunnels.length;t++)if(this.battleModel.model.tunnels[t].connectsNodes(this,e))return!0;return!1},updateCanBeReachedBySelectedNode:function(e){this.canBeReachedBySelectedNode=!1,e&&this.canReachNode(e)&&(this.canBeReachedBySelectedNode=!0)},_handleArmyArrivingAtEmptyNode:function(e){e.force>=this.DEFAULT_NODE_STRENGTH?this._setArmyAsOwner(e,e.force-this.DEFAULT_NODE_STRENGTH):(this.partialOwner=e.player,this._setOwnerStrength(e.force),e.destroy())},_handleArmyArrivingAtEnemyNode:function(e){e.force>this.ownerStrength?(e.force=e.force-this.ownerStrength,this._setOwnerStrength(0),this.currentOwner=null,this._handleArmyArrivingAtEmptyNode(e)):(this._setOwnerStrength(this.ownerStrength-e.force),e.destroy())},_setArmyAsOwner:function(e,t){(!t||0>t)&&(t=0),this._setOwnerStrength(t),this.currentOwner=e.player,this.partialOwner=null,e.destroy()},_setOwnerStrength:function(e){this.ownerStrength=Math.min(e,n)}},i}])}(),function(){angular.module("caveBattles.battle.constants",[]).constant("DEFAULT_FORCE_TO_TAKE",1).constant("FILL_NODES_EVERY",1e3).constant("PLAN_AI_EVERY",1e3)}(),function(){angular.module("caveBattles.battle-scheduler",["caveBattles.utils.ordered-list","caveBattles.battle-actions-factory","caveBattles.utils.timer"]).service("BattleScheduler",["$timeout","$interval","OrderedList","BattleEvents","BattleActionsFactory","Timer",function(e,t,n,i,o,r){var a=new n({orderBy:"timeAdded"}),l=new n({orderBy:"scheduledFor"}),s=null,c=function(e,t){for(var n=o.getAction(e,t),i=0;i<n.ongoingEvents.length;i++)a.add(n.ongoingEvents[i]);for(i=0;i<n.scheduledEvents.length;i++)l.add(n.scheduledEvents[i]);h()},d=function(e,n,i){t(function(){c(e,n)},i)},u=function(){a.forEach(function(e){e.update()})},h=function(){if(s&&e.cancel(s),l.firstElement){var t=l.firstElement.element.scheduledFor-r.getTime();0>=t&&(t=0),s=e(f,t)}},f=function(){var e=l.firstElement.element.relatedOngoingEvents;if(e)for(var t=0;t<e.length;t++)a.remove(e[t]);l.firstElement.element.execute(),l.pop(),h()};return{addEvent:c,addRecurringEvent:d,updateBattleInfo:u}}])}(),function(){function e(e,t,n,i,o,r){function a(e){f.nodes={},f.players=[],f.armies=[],f.tunnels=[],angular.forEach(e.map.nodes,function(e){f.nodes[e.id]=new o(e,v)}),angular.forEach(e.map.players,function(e){var n=new t(e);f.players.push(n),f.nodes[e.initialNode].currentOwner=n,f.nodes[e.initialNode].ownerStrength=n.initialForce}),angular.forEach(e.map.tunnels,function(e){f.tunnels.push(new n(e,f.nodes))}),s()}function l(e){for(var t in f.nodes)f.nodes[t].updateCanBeReachedBySelectedNode(e)}function s(){angular.forEach(m,function(e){e()})}function c(e){m.push(e),e()}function d(t){m=e.without(m,t)}function u(){for(var t=[],n=0;n<f.armies.length;n++)f.armies[n].deleted&&t.push(f.armies[n]);for(n=0;n<t.length;n++)f.armies=e.without(f.armies,t[n])}function h(e,t){var n=Math.floor(e.ownerStrength*r);if(0===n)return null;var o=new i({force:n,player:e.currentOwner,originNode:e});return e.ownerStrength=e.ownerStrength-n,f.armies.push(o),{army:o,destinationNode:t,force:n}}var f={nodes:null,players:null,armies:null,tunnels:null},m=[],v={init:a,cleanDeletedArmies:u,updateNodesThatCanBeReachedFromSelectedNode:l,model:f,subscribeToBattleModelInitiallised:c,unsubscribeToBattleModelInitiallised:d,moveForcesBetweenNodesAndGetRelatedEvent:h};return v}angular.module("caveBattles.battle-model",["ngLodash","caveBattles.player","caveBattles.tunnel","caveBattles.army","caveBattles.node","caveBattles.battle.constants"]).factory("BattleModel",e),e.$inject=["lodash","Player","Tunnel","Army","Node","DEFAULT_FORCE_TO_TAKE"]}(),function(){function e(e,t,n,i,o){function r(e){f=angular.copy(e),o.init(f),a()}function a(){e.addRecurringEvent(t.FILL_NODES,{},n),e.addRecurringEvent(t.PLAN_AI,{scheduler:e},i)}function l(){o.cleanDeletedArmies(),e.updateBattleInfo(v)}function s(e){c(),e.selected||e.currentOwner&&e.currentOwner.isHuman()&&(m=e,e.selected=!0),d()}function c(){m&&(m.selected=!1),m=null,d()}function d(){o.updateNodesThatCanBeReachedFromSelectedNode(m)}function u(n){if(m){var i=o.moveForcesBetweenNodesAndGetRelatedEvent(m,n);i&&e.addEvent(t.MOVE_ARMY,i),c()}}function h(){return!1}var f,m=null,v={init:r,requestSelection:s,hasEnded:h,update:l,requestNodeForcesToGoToNode:u,removeCurrentSelection:c};return v}angular.module("caveBattles.battle-handler",["caveBattles.battle-scheduler","caveBattles.battle.constants","caveBattles.battle-model"]).service("BattleHandler",e),e.$inject=["BattleScheduler","BattleEvents","FILL_NODES_EVERY","PLAN_AI_EVERY","BattleModel"]}(),function(){angular.module("caveBattles.battle-actions-factory",["caveBattles.utils.timer","caveBattles.simple-ai","caveBattles.battle-model"]).constant("BattleEvents",{MOVE_ARMY:"MOVE_ARMY",FILL_NODES:"FILL_NODES",PLAN_AI:"PLAN_AI",MOVE_ARMY_IA:"MOVE_ARMY_IA"}).factory("MoveArmyActionOnGoing",["Timer",function(e){var t=function(e){this.init(e)};return t.prototype={init:function(t){this.timeAdded=e.getTime(),this.army=t.army,this.destinationNode=t.destinationNode,this.progress=t.progress||0},update:function(){var t=e.getTime();this.army.updatePosition(t-this.timeAdded,this.destinationNode)}},t}]).factory("MoveArmyActionScheduled",["Timer",function(e){var t=function(e){this.init(e)};return t.prototype={init:function(t){this.relatedOngoingEvents=t.relatedOngoingEvents,this.army=t.army,this.scheduledFor=e.getTime()+1e3*this.army.timeToGetToDestination(t.destinationNode),this.destinationNode=t.destinationNode},execute:function(){this.destinationNode.handleArmyArriving(this.army)}},t}]).factory("FillNodesActionScheduled",["Timer","BattleModel",function(e,t){var n=function(e){this.init(e)};return n.prototype={init:function(t){this.relatedOngoingEvents=t.relatedOngoingEvents,this.scheduledFor=e.getTime()},execute:function(){angular.forEach(t.model.nodes,function(e){e.fillNode()})}},n}]).factory("MoveArmyAction",["MoveArmyActionOnGoing","MoveArmyActionScheduled",function(e,t){var n=function(e){this.init(e)};return n.prototype={init:function(n){this.ongoingEvents=[],this.scheduledEvents=[],n.army&&n.army.force&&(this.ongoingEvents.push(new e({army:n.army,destinationNode:n.destinationNode})),this.scheduledEvents.push(new t({army:n.army,destinationNode:n.destinationNode,relatedOngoingEvents:this.ongoingEvents})))}},n}]).factory("MoveArmyIAActionScheduled",["Timer","BattleEvents","BattleModel",function(e,t,n){var i=function(e){this.init(e)};return i.prototype={init:function(t){this.relatedOngoingEvents=t.relatedOngoingEvents,this.army=t.army,this.scheduledFor=e.getTime(),this.destinationNode=t.destinationNode,this.originNode=t.originNode,this.scheduler=t.scheduler},execute:function(){var e=n.moveForcesBetweenNodesAndGetRelatedEvent(this.originNode,this.destinationNode);e&&this.scheduler.addEvent(t.MOVE_ARMY,e)}},i}]).factory("MoveArmyIAAction",["MoveArmyIAActionScheduled",function(e){var t=function(e){this.init(e)};return t.prototype={init:function(t){this.ongoingEvents=[],this.scheduledEvents=[],t.originNode&&t.destinationNode&&this.scheduledEvents.push(new e({originNode:t.originNode,destinationNode:t.destinationNode,scheduler:t.scheduler,relatedOngoingEvents:this.ongoingEvents}))}},t}]).factory("FillNodesAction",["FillNodesActionScheduled",function(e){var t=function(e){this.init(e)};return t.prototype={init:function(){this.ongoingEvents=[],this.scheduledEvents=[],this.scheduledEvents.push(new e({relatedOngoingEvents:this.ongoingEvents}))}},t}]).factory("PlanAIActionScheduled",["Timer","BattleModel","SimpleAI",function(e,t,n){var i=function(e){this.init(e)};return i.prototype={init:function(t){this.relatedOngoingEvents=t.relatedOngoingEvents,this.scheduler=t.scheduler,this.scheduledFor=e.getTime()},execute:function(){var e=this;angular.forEach(t.model.players,function(i){if(i.isAI()){var o=n.getNextAction(i,t.model.nodes);o&&(o.params.scheduler=e.scheduler,e.scheduler.addEvent(o.name,o.params))}})}},i}]).factory("PlanAIAction",["PlanAIActionScheduled",function(e){var t=function(e){this.init(e)};return t.prototype={init:function(t){this.ongoingEvents=[],this.scheduledEvents=[],this.scheduledEvents.push(new e({nodes:t.nodes,players:t.players,relatedOngoingEvents:this.ongoingEvents,scheduler:t.scheduler}))}},t}]).factory("BattleActionsFactory",["BattleEvents","MoveArmyAction","FillNodesAction","PlanAIAction","MoveArmyIAAction",function(e,t,n,i,o){var r=function(r,a){switch(r){case e.MOVE_ARMY:return new t(a);case e.FILL_NODES:return new n(a);case e.PLAN_AI:return new i(a);case e.MOVE_ARMY_IA:return new o(a)}};return{getAction:r}}])}(),function(){angular.module("caveBattles.army",["caveBattles.utils.geometry"]).factory("Army",["Geometry",function(e){var t=function(e){this.DEFAULT_INIT_FORCE=20,this.DEFAULT_SPEED=5,this.player=e.player,this.position=angular.copy(e.node?e.node.position:e.originNode.position),this.node=e.node,this.originNode=e.originNode,this.force=angular.isUndefined(e.force)?this.DEFAULT_INIT_FORCE:e.force};return t.prototype={timeToGetToDestination:function(t){var n=e.distanceBetweenPoints(this.originNode.position,t.position);return n/this.DEFAULT_SPEED},updatePosition:function(t,n){var i=t/1e3/this.timeToGetToDestination(n);i>1&&(i=1),0>i&&(i=0),this.position=e.getPointInBetween(this.originNode.position,n.position,i)},removeForce:function(e){this.force=this.force-e,this.force<=0&&this.destroy()},destroy:function(){this.force=0,this.deleted=!0}},t}])}(),function(){function e(e){function t(e,t){var i=n(t,e);return o(i)}function n(e,t){var n=[];return angular.forEach(e,function(o){i(o,t)&&(n=n.concat(r(o,e,t)))}),n}function i(e,t){return e.currentOwner&&e.currentOwner===t}function o(e){var t=0;return e.length>1&&(t=Math.floor(Math.random()*e.length)),e[t]}function r(e,t,n){var o=[];return angular.forEach(t,function(t){e.canReachNode(t)&&!i(t,n)&&e.ownerStrength>20&&o.push(a(e,t))}),o}function a(t,n){return{name:e.MOVE_ARMY_IA,params:{originNode:t,destinationNode:n}}}var l={getNextAction:t};return l}angular.module("caveBattles.simple-ai",["caveBattles.battle-actions-factory"]).factory("SimpleAI",e),e.$inject=["BattleEvents"]}(),angular.module("caveBattles",["ngAnimate","ngCookies","ngTouch","ngSanitize","restangular","caveBattles.main"]),angular.module("caveBattles").run(["$templateCache",function(e){e.put("app/battle-view/battle-view.tpl.html","<div class='battle-view' ng-click='onBackgroundClicked()'>\n    <div ng-repeat='node in battleInfo.nodes'>\n        <node node-info='node'></node>\n    </div>\n    <div ng-repeat='tunnel in battleInfo.tunnels'>\n        <tunnel tunnel-info='tunnel'></tunnel>\n    </div>\n\n    <div ng-repeat='army in battleInfo.armies'>\n        <army army-info='army'></army>\n    </div>\n</div>"),e.put("app/battle-view/army/army.tpl.html",'<div class=\'army player-{{armyInfo.player.number}}\'\n     ng-style=\'{"top": armyInfo.position.y + "%", "left": armyInfo.position.x + "%"}\'\n        >\n     {{armyInfo.force}}\n </div>'),e.put("app/battle-view/node/node.tpl.html","<div\n    class='node player-{{nodeInfo.currentOwner.number}}'\n    ng-class='{\n        \"can-be-clicked\": nodeInfo.canBeReachedBySelectedNode,\n        \"selected\": nodeInfo.selected,\n        \"has-owner\": !!nodeInfo.currentOwner\n    }'\n    ng-style='{\"top\": nodeInfo.position.y + \"%\", \"left\": nodeInfo.position.x + \"%\"}',\n    ng-click='nodeClicked($event)'\n>\n\n    <div class='node-inner'></div>\n    <div class='node-owner-strength' ng-show='!!nodeInfo.currentOwner' >{{nodeInfo.ownerStrength}}</div>\n    <div class='node-partial-owner-strength  player-{{nodeInfo.partialOwner.number}}' ng-show='!!nodeInfo.partialOwner' >\n        <div class='node-partial-owner-strength-inner' ng-style='{\"top\": getTopFill() + \"%\"}' ></div>\n    </div>\n</div>"),e.put("app/battle-view/tunnel/tunnel.tpl.html",'<div    class=\'tunnel\'\n        ng-style=\'{\n            "width": tunnelInfo.length + "%",\n            "top": tunnelInfo.middle.y + "%",\n            "left": tunnelInfo.middle.x + "%",\n            "margin-left": -(tunnelInfo.length/2) + "%",\n            "transform": "rotate(" + tunnelInfo.inclinationDeg + "deg)"\n        }\'>\n</div>')}]);